---
- name: Create nodes - OpenStack
  hosts: localhost
  gather_facts: no
  vars:
    - mgmt_network_name: "{{ provisioner.network.nic.net_1.name }}"
  tasks:
    - name: Create nodes
      nova_compute:
           auth_url: "{{ provisioner.url }}"
           state: present
           login_username: "{{ provisioner.username }}"
           login_password: "{{ provisioner.password }}"
           login_tenant_name: "{{ provisioner.tenant_name }}"
           name: "{{ item.value.name }}"
           image_id: "{{ item.value.image_id }}"
           key_name: "{{ provisioner.key_name }}"
           flavor_id: "{{ item.value.flavor_id }}"
           nics: "{{ item.value.nics }}"
           config_drive: True
           auto_floating_ip: "{{ provisioner.use_floating_ip }}"
           wait_for: 200
      retries: 4
      with_dict: nodes
      register: created_nodes

    - name: Add created hosts to host list
      add_host:
        name="{{ item.item.value.name }}"
        groups="{{ item.item.value.groups
            if item.item.value.groups is string
            else item.item.value.groups| join(',') }}"
        ansible_fqdn="{{ item.item.value.hostname }}"
        ansible_ssh_user="{{ item.item.value.remote_user }}"
        ansible_ssh_private_key_file="{{ provisioner.key_file }}"
        ansible_ssh_host={%- if item.public_ip %}{{ item.public_ip }}{%- else %}{{ item.info.addresses[provisioner.network.nic.net_1.name][0].addr }}{% endif %}
        provisioner_host_addresses="{{ item.info.addresses|to_json }}"
      with_items: created_nodes.results

- name: wait for hosts to get reachable
  hosts: openstack_nodes
  tasks:
    - include: "{{ lookup('env', 'PWD') }}/tasks/wait_for_ssh.yml"

- name: Update network interfaces on nodes - OpenStack
  hosts: openstack_nodes
  gather_facts: yes
  sudo: yes
  tasks:
    - name: Setup networking (interfaces)
      template:
            src: ../templates/ifcfg-interface.j2
            dest: /etc/sysconfig/network-scripts/ifcfg-{{ item.interface }}
            owner: root
            group: root
            mode: 644
      with_items: nodes.controller.net_interfaces
      register: reboot_reason 
    - include: "{{ lookup('env', 'PWD') }}/tasks/reboot.yml"

